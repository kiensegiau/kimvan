import { useState, useEffect } from 'react';

// Constants for cache
const CACHE_DURATION = 12 * 60 * 60 * 1000; // 12 gi·ªù 
const MAX_CACHE_ITEMS = 5; // Gi·ªØ t·ªëi ƒëa 5 cache items

export function useApiSheetData(courseId) {
  const [apiSheetData, setApiSheetData] = useState(null);
  const [loadingApiSheet, setLoadingApiSheet] = useState(false);
  const [apiSheetError, setApiSheetError] = useState(null);
  const [activeApiSheet, setActiveApiSheet] = useState(0);
  const [cacheStatus, setCacheStatus] = useState('');
  
  // H√†m l∆∞u d·ªØ li·ªáu v√†o cache
  const saveSheetListToCache = (data) => {
    try {
      // Check if running in browser environment
      if (typeof window === 'undefined') return;
      
      // T·∫°o ƒë·ªëi t∆∞·ª£ng cache v·ªõi d·ªØ li·ªáu v√† th·ªùi gian
      const cacheItem = {
        data: data,
        timestamp: Date.now()
      };
      
      // L∆∞u d·ªØ li·ªáu sheet v√†o cache
      const cacheKey = `sheet-list-${courseId}`;
      localStorage.setItem(cacheKey, JSON.stringify(cacheItem));
      
      // D·ªçn d·∫πp cache c≈©
      cleanupOldCaches();
      
      setCacheStatus('saved-list');
      console.log(`‚úÖ ƒê√£ l∆∞u danh s√°ch sheet cho kh√≥a h·ªçc ${courseId} v√†o cache`);
    } catch (error) {
      console.error('L·ªói khi l∆∞u cache sheet list:', error);
    }
  };
  
  // H√†m l∆∞u d·ªØ li·ªáu chi ti·∫øt sheet v√†o cache
  const saveSheetDetailToCache = (sheetId, data) => {
    try {
      // Check if running in browser environment
      if (typeof window === 'undefined') return;
      
      // T·∫°o ƒë·ªëi t∆∞·ª£ng cache v·ªõi d·ªØ li·ªáu v√† th·ªùi gian
      const cacheItem = {
        data: data,
        timestamp: Date.now()
      };
      
      // L∆∞u d·ªØ li·ªáu chi ti·∫øt sheet v√†o cache
      const cacheKey = `sheet-detail-${sheetId}`;
      localStorage.setItem(cacheKey, JSON.stringify(cacheItem));
      
      setCacheStatus(`saved-detail-${sheetId}`);
      console.log(`‚úÖ ƒê√£ l∆∞u chi ti·∫øt sheet ${sheetId} v√†o cache`);
    } catch (error) {
      console.error('L·ªói khi l∆∞u cache sheet detail:', error);
    }
  };
  
  // H√†m l·∫•y d·ªØ li·ªáu danh s√°ch sheet t·ª´ cache
  const getSheetListFromCache = () => {
    try {
      // Check if running in browser environment
      if (typeof window === 'undefined') return null;
      
      const cacheKey = `sheet-list-${courseId}`;
      const cachedData = localStorage.getItem(cacheKey);
      if (!cachedData) return null;
      
      const cacheItem = JSON.parse(cachedData);
      const now = Date.now();
      
      // Ki·ªÉm tra xem cache c√≥ c√≤n hi·ªáu l·ª±c kh√¥ng
      if (now - cacheItem.timestamp > CACHE_DURATION) {
        localStorage.removeItem(cacheKey);
        setCacheStatus('expired-list');
        console.log(`üïí Cache danh s√°ch sheet c·ªßa kh√≥a h·ªçc ${courseId} ƒë√£ h·∫øt h·∫°n`);
        return null;
      }
      
      setCacheStatus('hit-list');
      console.log(`‚úÖ ƒê√£ l·∫•y danh s√°ch sheet c·ªßa kh√≥a h·ªçc ${courseId} t·ª´ cache`);
      return cacheItem.data;
    } catch (error) {
      console.error('L·ªói khi ƒë·ªçc cache danh s√°ch sheet:', error);
      return null;
    }
  };
  
  // H√†m l·∫•y d·ªØ li·ªáu chi ti·∫øt sheet t·ª´ cache
  const getSheetDetailFromCache = (sheetId) => {
    try {
      // Check if running in browser environment
      if (typeof window === 'undefined') return null;
      
      const cacheKey = `sheet-detail-${sheetId}`;
      const cachedData = localStorage.getItem(cacheKey);
      if (!cachedData) return null;
      
      const cacheItem = JSON.parse(cachedData);
      const now = Date.now();
      
      // Ki·ªÉm tra xem cache c√≥ c√≤n hi·ªáu l·ª±c kh√¥ng
      if (now - cacheItem.timestamp > CACHE_DURATION) {
        localStorage.removeItem(cacheKey);
        setCacheStatus(`expired-detail-${sheetId}`);
        console.log(`üïí Cache chi ti·∫øt sheet ${sheetId} ƒë√£ h·∫øt h·∫°n`);
        return null;
      }
      
      setCacheStatus(`hit-detail-${sheetId}`);
      console.log(`‚úÖ ƒê√£ l·∫•y chi ti·∫øt sheet ${sheetId} t·ª´ cache`);
      return cacheItem.data;
    } catch (error) {
      console.error('L·ªói khi ƒë·ªçc cache chi ti·∫øt sheet:', error);
      return null;
    }
  };
  
  // H√†m d·ªçn d·∫πp c√°c cache c≈©
  const cleanupOldCaches = () => {
    try {
      // Check if running in browser environment
      if (typeof window === 'undefined') return;
      
      // L·∫•y t·∫•t c·∫£ keys trong localStorage
      const keys = Object.keys(localStorage);
      
      // L·ªçc c√°c key li√™n quan ƒë·∫øn cache sheet
      const sheetListCacheKeys = keys.filter(key => key.startsWith('sheet-list-'));
      const sheetDetailCacheKeys = keys.filter(key => key.startsWith('sheet-detail-'));
      
      // X·ª≠ l√Ω cache danh s√°ch sheet
      if (sheetListCacheKeys.length > MAX_CACHE_ITEMS) {
        const cacheItems = [];
        
        for (const key of sheetListCacheKeys) {
          try {
            const item = JSON.parse(localStorage.getItem(key));
            if (item && item.timestamp) {
              cacheItems.push({ key, timestamp: item.timestamp });
            }
          } catch (e) {
            localStorage.removeItem(key);
          }
        }
        
        cacheItems.sort((a, b) => a.timestamp - b.timestamp);
        
        for (let i = 0; i < cacheItems.length - MAX_CACHE_ITEMS; i++) {
          localStorage.removeItem(cacheItems[i].key);
          console.log(`üóëÔ∏è ƒê√£ x√≥a cache danh s√°ch sheet c≈©: ${cacheItems[i].key}`);
        }
      }
      
      // X·ª≠ l√Ω cache chi ti·∫øt sheet
      if (sheetDetailCacheKeys.length > MAX_CACHE_ITEMS * 3) { // Cho ph√©p nhi·ªÅu cache chi ti·∫øt h∆°n
        const cacheItems = [];
        
        for (const key of sheetDetailCacheKeys) {
          try {
            const item = JSON.parse(localStorage.getItem(key));
            if (item && item.timestamp) {
              cacheItems.push({ key, timestamp: item.timestamp });
            }
          } catch (e) {
            localStorage.removeItem(key);
          }
        }
        
        cacheItems.sort((a, b) => a.timestamp - b.timestamp);
        
        for (let i = 0; i < cacheItems.length - (MAX_CACHE_ITEMS * 3); i++) {
          localStorage.removeItem(cacheItems[i].key);
          console.log(`üóëÔ∏è ƒê√£ x√≥a cache chi ti·∫øt sheet c≈©: ${cacheItems[i].key}`);
        }
      }
    } catch (e) {
      // X·ª≠ l√Ω l·ªói im l·∫∑ng
    }
  };
  
  // H√†m x√≥a cache hi·ªán t·∫°i
  const clearCurrentCache = () => {
    try {
      // Check if running in browser environment
      if (typeof window === 'undefined') return;
      
      const listCacheKey = `sheet-list-${courseId}`;
      localStorage.removeItem(listCacheKey);
      
      // X√≥a chi ti·∫øt c·ªßa sheet ƒë√£ ƒë∆∞·ª£c t·∫£i
      if (apiSheetData && apiSheetData.sheets) {
        apiSheetData.sheets.forEach(sheet => {
          const detailCacheKey = `sheet-detail-${sheet._id}`;
          localStorage.removeItem(detailCacheKey);
        });
      }
      
      setCacheStatus('cleared');
      console.log(`üóëÔ∏è ƒê√£ x√≥a t·∫•t c·∫£ cache li√™n quan ƒë·∫øn kh√≥a h·ªçc ${courseId}`);
    } catch (error) {
      console.error('L·ªói khi x√≥a cache:', error);
    }
  };
  
  // H√†m l·∫•y d·ªØ li·ªáu sheet t·ª´ API
  const fetchApiSheetData = async () => {
    if (!courseId) return;
    
    setLoadingApiSheet(true);
    setApiSheetError(null);
    
    // Ki·ªÉm tra cache tr∆∞·ªõc
    const cachedData = getSheetListFromCache();
    if (cachedData) {
      setApiSheetData(cachedData);
      
      // N·∫øu c√≥ sheets v√† c√≥ sheet ƒë·∫ßu ti√™n, ki·ªÉm tra xem c√≥ chi ti·∫øt ƒë√£ cache ch∆∞a
      if (cachedData.sheets && cachedData.sheets.length > 0) {
        const firstSheetId = cachedData.sheets[0]._id;
        const cachedDetail = getSheetDetailFromCache(firstSheetId);
        
        if (cachedDetail) {
          // C·∫≠p nh·∫≠t d·ªØ li·ªáu sheet trong state v·ªõi d·ªØ li·ªáu t·ª´ cache
          setApiSheetData(prevData => {
            if (!prevData || !prevData.sheets) return prevData;
            
            const updatedSheets = prevData.sheets.map(sheet => {
              if (sheet._id === firstSheetId) {
                return { ...sheet, detail: cachedDetail };
              }
              return sheet;
            });
            
            return { ...prevData, sheets: updatedSheets };
          });
        } else {
          // N·∫øu kh√¥ng c√≥ cache chi ti·∫øt, t·∫£i t·ª´ API
          await fetchSheetDetail(firstSheetId);
        }
      }
      
      setLoadingApiSheet(false);
      return;
    }
    
    try {
      // The API endpoint handles both MongoDB ObjectIDs and kimvanIds
      const response = await fetch(`/api/courses/${courseId}/sheets`);
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        const errorMessage = errorData.error || `L·ªói ${response.status}: ${response.statusText}`;
        throw new Error(errorMessage);
      }
      
      const result = await response.json();
      
      if (result.success) {
        // L∆∞u k·∫øt qu·∫£ v√†o cache
        saveSheetListToCache(result);
        
        setApiSheetData(result);
        
        // N·∫øu c√≥ sheets
        if (result.sheets && result.sheets.length > 0) {
          // L·∫•y d·ªØ li·ªáu chi ti·∫øt c·ªßa sheet ƒë·∫ßu ti√™n
          const firstSheetId = result.sheets[0]._id;
          await fetchSheetDetail(firstSheetId);
        }
      } else {
        setApiSheetError(result.error || result.message || 'Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu sheet t·ª´ API');
      }
    } catch (error) {
      console.error('L·ªói khi l·∫•y d·ªØ li·ªáu sheet t·ª´ API:', error);
      setApiSheetError(error.message || 'ƒê√£ x·∫£y ra l·ªói khi l·∫•y d·ªØ li·ªáu sheet');
    } finally {
      setLoadingApiSheet(false);
    }
  };
  
  // H√†m l·∫•y chi ti·∫øt c·ªßa m·ªôt sheet
  const fetchSheetDetail = async (sheetId) => {
    if (!sheetId) {
      setApiSheetError('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt: ID sheet kh√¥ng h·ª£p l·ªá');
      return null;
    }
    
    // Ki·ªÉm tra cache tr∆∞·ªõc
    const cachedDetail = getSheetDetailFromCache(sheetId);
    if (cachedDetail) {
      // C·∫≠p nh·∫≠t d·ªØ li·ªáu sheet trong state v·ªõi d·ªØ li·ªáu t·ª´ cache
      setApiSheetData(prevData => {
        if (!prevData || !prevData.sheets) return prevData;
        
        const updatedSheets = prevData.sheets.map(sheet => {
          if (sheet._id === sheetId) {
            return { ...sheet, detail: cachedDetail };
          }
          return sheet;
        });
        
        return { ...prevData, sheets: updatedSheets };
      });
      
      setApiSheetError(null);
      return cachedDetail;
    }
    
    setLoadingApiSheet(true);
    
    try {
      // S·ª≠ d·ª•ng tham s·ªë fetchData=true ƒë·ªÉ l·∫•y ƒë·∫ßy ƒë·ªß d·ªØ li·ªáu bao g·ªìm c·∫£ HTML
      const response = await fetch(`/api/sheets/${sheetId}?fetchData=true`);
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        const errorMessage = errorData.error || `L·ªói ${response.status}: ${response.statusText}`;
        throw new Error(errorMessage);
      }
      
      const result = await response.json();
      
      if (result.success) {
        // L∆∞u v√†o cache
        saveSheetDetailToCache(sheetId, result.sheet);
        
        // C·∫≠p nh·∫≠t d·ªØ li·ªáu sheet trong state
        setApiSheetData(prevData => {
          if (!prevData || !prevData.sheets) return prevData;
          
          const updatedSheets = prevData.sheets.map(sheet => {
            if (sheet._id === sheetId) {
              return { ...sheet, detail: result.sheet };
            }
            return sheet;
          });
          
          return { ...prevData, sheets: updatedSheets };
        });
        
        setApiSheetError(null);
        return result.sheet;
      } else {
        setApiSheetError(result.error || result.message || `Kh√¥ng th·ªÉ l·∫•y chi ti·∫øt sheet`);
        return null;
      }
    } catch (error) {
      console.error('L·ªói khi t·∫£i chi ti·∫øt sheet:', error);
      setApiSheetError(`L·ªói khi t·∫£i chi ti·∫øt sheet: ${error.message}`);
      return null;
    } finally {
      setLoadingApiSheet(false);
    }
  };
  
  // H√†m chuy·ªÉn ƒë·ªïi sheet active
  const changeActiveSheet = async (index) => {
    setActiveApiSheet(index);
    
    // N·∫øu ƒë√£ c√≥ d·ªØ li·ªáu sheet
    if (apiSheetData && apiSheetData.sheets && apiSheetData.sheets[index]) {
      const sheet = apiSheetData.sheets[index];
      
      // N·∫øu ch∆∞a c√≥ chi ti·∫øt, l·∫•y chi ti·∫øt
      if (!sheet.detail) {
        await fetchSheetDetail(sheet._id);
      }
    } else {
      setApiSheetError("Kh√¥ng th·ªÉ chuy·ªÉn sheet: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu sheet ho·∫∑c index kh√¥ng h·ª£p l·ªá");
    }
  };
  
  // L·∫•y d·ªØ li·ªáu ban ƒë·∫ßu khi component mount
  useEffect(() => {
    if (courseId) {
      fetchApiSheetData();
    }
  }, [courseId]);
  
  return {
    apiSheetData,
    loadingApiSheet,
    apiSheetError,
    activeApiSheet,
    cacheStatus,
    setActiveApiSheet: changeActiveSheet,
    fetchApiSheetData,
    fetchSheetDetail,
    clearCache: clearCurrentCache
  };
} 